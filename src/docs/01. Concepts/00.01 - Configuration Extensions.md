---
title: "Configuration Extensions"
description: "Enhanced configuration management capabilities that extend the standard .NET Core configuration system with Azure Key Vault integration, local development support, and intelligent file resolution."
author: "Diginsight Team"
date: "2025-09-08"
categories: ["concepts", "configuration", "azure", "development"]
tags: ["configuration", "appsettings", "azure-key-vault", "development", "production"]
order: 1
---

Configuration Extensions in Diginsight Components provide **enhanced configuration management** capabilities that extend the standard .NET Core configuration system. These extensions offer advanced configuration loading, Azure Key Vault integration, and intelligent file resolution to support both development and production scenarios.

## Table of Contents

- [üìã Overview](#-overview)
- [‚ú® Key Benefits](#-key-benefits)
- [üèóÔ∏è Enhanced Configuration Hierarchy](#Ô∏è-enhanced-configuration-hierarchy)
  - [Local Development Files](#local-development-files)
  - [Environment files selection with AppsettingsEnvironmentName](#environment-files-selection-with-appsettingsenvironmentname)
- [üîê Azure Key Vault Integration](#-azure-key-vault-integration)
- [üõ†Ô∏è Getting Started](#Ô∏è-getting-started)
- [üí° Usage Patterns](#-usage-patterns)
- [üîß Advanced Configuration](#-advanced-configuration)
- [üåç Environment Support](#-environment-support)
- [üíª Best Practices](#-best-practices)
- [üêõ Troubleshooting](#-troubleshooting)

## üìã Overview

The Configuration Extensions enhance the standard .NET Core configuration system by providing:

- **Extended File Hierarchy**: Additional configuration layers beyond the standard appsettings.json
- **Local Development Support**: Special `.local.json` files for development scenarios
- **Azure Key Vault Integration**: Seamless secrets management with automatic authentication
- **External Configuration Folders**: Configuration files stored outside the application directory
- **Intelligent File Resolution**: Hierarchical search for configuration files
- **Multi-Environment Support**: Environment-specific configuration with smart defaults

These extensions are part of the **Diginsight.Components.Configuration** package and work seamlessly with existing .NET applications.

> **‚ú® Key Benefits**
> 
> - üöÄ **Zero-Configuration Setup**
> Replace your standard configuration setup with a single method call and get enhanced capabilities immediately.
> - üîí **Built-in Security**
> Automatic Azure Key Vault integration with support for managed identities, client secrets, and development credentials.
> - üîß **Development-Friendly**
> Local override files that don't interfere with source control, making development and debugging easier.
> - ‚òÅÔ∏è **Production-Ready**
> Robust production configuration with external folder support and proper secret management.
> - üéØ **Backward Compatible**
> Works as a drop-in replacement for standard .NET configuration without breaking existing code.

## üèóÔ∏è Enhanced Configuration Hierarchy

Standard .NET Core provides this configuration hierarchy:

```
üìÅ Standard .NET Configuration
‚îú‚îÄ‚îÄ appsettings.json (lowest priority)
‚îú‚îÄ‚îÄ appsettings.{Environment}.json
‚îú‚îÄ‚îÄ User Secrets (Development only)
‚îî‚îÄ‚îÄ Environment Variables (highest priority)
```

Diginsight Configuration Extensions enhance this with additional layers:

```
üìÅ Enhanced Configuration Hierarchy
‚îú‚îÄ‚îÄ appsettings.json (lowest priority)
‚îú‚îÄ‚îÄ appsettings.{Environment}.json
‚îú‚îÄ‚îÄ üÜï appsettings.local.json (Development only)
‚îú‚îÄ‚îÄ üÜï appsettings.{Environment}.local.json (Development only)
‚îú‚îÄ‚îÄ üÜï Azure Key Vault secrets (if configured)
‚îú‚îÄ‚îÄ User Secrets (Development only)
‚îî‚îÄ‚îÄ Environment Variables (highest priority)
```

### Local Development Files

The `.local.json` files provide a clean way to override configuration during development:

- **Purpose**: Local development overrides without affecting source control
- **Environment**: Only loaded in Development environment
- **Security**: Should be added to `.gitignore` to prevent accidental commits
- **Usage**: Override connection strings, API endpoints, and environment-specific values

**Example: `appsettings.local.json`**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=MyApp_Dev;Trusted_Connection=true;"
  },
  "ExternalServices": {
    "ApiBaseUrl": "https://localhost:5001/api",
    "ApiKey": "dev-key-12345"
  }
}
```

### Environment files selection with AppsettingsEnvironmentName

Configuration Extensions work seamlessly with the standard .NET Core environment system, which typically uses these environment variables:

- **`DOTNET_ENVIRONMENT`** for client or console applications
- **`ASPNETCORE_ENVIRONMENT`** for Web APIs or Web applications

**Standard Environment Behavior**
By default, the configuration system uses the environment name from these variables to select the appropriate configuration files:

```bash
# Standard environment setup
DOTNET_ENVIRONMENT=Development
# Loads: appsettings.json + appsettings.Development.json

ASPNETCORE_ENVIRONMENT=Production  
# Loads: appsettings.json + appsettings.Production.json
```

**Enhanced Environment Selection with AppsettingsEnvironmentName**

In some scenarios, it's useful to keep the standard environment variables set to `Production` to enable full authentication logic and production-ready behavior, while still loading different configuration files for the specific deployment environment.

For this purpose, Configuration Extensions support the **`AppsettingsEnvironmentName`** environment variable, which overrides the standard environment variables **only for configuration file selection**:

```bash
# Keep standard behavior as Production
DOTNET_ENVIRONMENT=Production
ASPNETCORE_ENVIRONMENT=Production

# Override configuration file selection
AppsettingsEnvironmentName=Staging

# Result: 
# - Application runs with Production environment behavior
# - Configuration loads: appsettings.json + appsettings.Staging.json
```

#### Common Use Cases

##### 1. Staging Environment with Production Security

```bash
# Environment Variables
ASPNETCORE_ENVIRONMENT=Production     # Full authentication enabled
AppsettingsEnvironmentName=Stage    # Load staging configuration

# Configuration Files Loaded:
# ‚îú‚îÄ‚îÄ appsettings.json
# ‚îú‚îÄ‚îÄ appsettings.Stage.json        # ‚Üê Uses AppsettingsEnvironmentName
# ‚îî‚îÄ‚îÄ Environment Variables
```

##### 2. UAT Environment with Production Features

```bash
# Environment Variables  
DOTNET_ENVIRONMENT=Production         # Production feature flags
AppsettingsEnvironmentName=UAT        # Load UAT-specific config

# Configuration Files Loaded:
# ‚îú‚îÄ‚îÄ appsettings.json
# ‚îú‚îÄ‚îÄ appsettings.UAT.json            # ‚Üê Uses AppsettingsEnvironmentName
# ‚îî‚îÄ‚îÄ Environment Variables
```

##### 3. Multiple Production Deployments

```bash
# Blue Deployment
ASPNETCORE_ENVIRONMENT=Production
AppsettingsEnvironmentName=Production-Blue

# Green Deployment  
ASPNETCORE_ENVIRONMENT=Production
AppsettingsEnvironmentName=Production-Green

# Each loads different configuration while maintaining Production behavior
```

#### Priority and Override Logic

The environment file selection follows this priority:

1. **`AppsettingsEnvironmentName`** (if set) - **Highest Priority**
2. **`ASPNETCORE_ENVIRONMENT`** (for web applications)
3. **`DOTNET_ENVIRONMENT`** (for all applications)
4. **Default fallback** (no environment-specific files)

```csharp
// Pseudo-code for environment resolution
string environmentName = 
    Environment.GetEnvironmentVariable("AppsettingsEnvironmentName") ??
    Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ??
    Environment.GetEnvironmentVariable("DOTNET_ENVIRONMENT") ??
    "Production";

// Load configuration files
// appsettings.json
// appsettings.{environmentName}.json
// appsettings.{environmentName}.local.json (Development only)
```

#### Best Practices

##### ‚úÖ Recommended Usage

```bash
# Production with environment-specific configuration
ASPNETCORE_ENVIRONMENT=Production
AppsettingsEnvironmentName=Staging
```

##### ‚úÖ Development Override

```bash
# Development with custom configuration set
DOTNET_ENVIRONMENT=Development  
AppsettingsEnvironmentName=Integration
```

##### ‚ö†Ô∏è Be Careful With

```bash
# Avoid confusing combinations
ASPNETCORE_ENVIRONMENT=Development
AppsettingsEnvironmentName=Production  # This might load prod config in dev mode
```

##### üîí Security Considerations

- Ensure `AppsettingsEnvironmentName` configuration files don't contain secrets incompatible with the runtime environment
- Use Azure Key Vault for environment-specific secrets
- Validate that the combination of environment behavior and configuration is secure



## üîê Azure Key Vault Integration

Configuration Extensions provide seamless Azure Key Vault integration through a standard configuration section:

### Basic Azure Key Vault Configuration

```json
{
  "AzureKeyVault": {
    "Uri": "https://your-keyvault.vault.azure.net/",
    "TenantId": "your-tenant-id",
    "ClientId": "your-client-id",
    "ClientSecret": ""  // Leave empty for managed identity
  }
}
```

Authentication to the Azure Key Vault happens by means of DefaultCredentialProvider class, which supports the authentication methods:

- **Development Environment**
    ```csharp
    // Automatic authentication chain:
    // 1. Azure CLI Credential
    // 2. Visual Studio Code Credential  
    // 3. Visual Studio Credential
    // 4. Client Secret Credential (if provided)
    ```

- **Production Environment**
    ```csharp
    // Production authentication:
    // 1. Managed Identity Credential (recommended)
    // 2. Client Secret Credential (if provided)
    ```

### Key Vault Secret Naming

Configuration Extensions automatically convert Key Vault secret names to .NET configuration keys:

| Key Vault Secret Name | Configuration Key |
|----------------------|-------------------|
| `MyApp--Database--ConnectionString` | `MyApp:Database:ConnectionString` |
| `ConnectionStrings--DefaultConnection` | `ConnectionStrings:DefaultConnection` |
| `ApiSettings--BaseUrl` | `ApiSettings:BaseUrl` |



## üõ†Ô∏è Getting Started

### Installation

Install the Configuration Extensions package:

```bash
dotnet add package Diginsight.Components.Configuration
```

### Basic Setup

Replace your standard configuration setup with the enhanced version:

#### **Before: Standard .NET Configuration**
```csharp
var builder = WebApplication.CreateBuilder(args);
// Standard configuration only
```

#### **After: Enhanced Configuration**
```csharp
var builder = WebApplication.CreateBuilder(args);
builder.Host.ConfigureAppConfiguration2(loggerFactory);
```

#### **Generic Host Applications**
```csharp
var host = Host.CreateDefaultBuilder(args)
    .ConfigureAppConfiguration2(loggerFactory)
    .ConfigureServices(services =>
    {
        // Your service configuration
    })
    .Build();
```

### Immediate Benefits

After setup, you immediately get:

- ‚úÖ Support for `.local.json` files
- ‚úÖ Azure Key Vault integration (if configured)
- ‚úÖ External configuration folder support
- ‚úÖ Enhanced file resolution
- ‚úÖ All standard .NET configuration features

## üí° Usage Patterns

### Development Workflow

#### 1. **Base Configuration** (`appsettings.json`)
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=MyApp;"
  }
}
```

#### 2. **Development Overrides** (`appsettings.Development.json`)
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft": "Warning"
    }
  }
}
```

#### 3. **Local Development** (`appsettings.local.json`)
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=MyApp_Local;Trusted_Connection=true;"
  },
  "ExternalServices": {
    "ApiKey": "local-development-key"
  }
}
```

### Production Deployment

#### 1. **Production Configuration** (`appsettings.Production.json`)
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning"
    }
  },
  "AzureKeyVault": {
    "Uri": "https://prod-keyvault.vault.azure.net/",
    "TenantId": "production-tenant-id"
  }
}
```

#### 2. **Azure Key Vault Secrets**
- `ConnectionStrings--DefaultConnection`
- `ExternalServices--ApiKey`
- `ApplicationInsights--ConnectionString`

#### 3. **Environment Variables**
```bash
DOTNET_ENVIRONMENT=Production
ASPNETCORE_URLS=https://+:443;http://+:80
```

## üîß Advanced Configuration

### External Configuration Folders

Store configuration files outside your application directory for enhanced security:

```bash
# Set external configuration folder
export ExternalConfigurationFolder="/etc/myapp/config"
```

The system performs intelligent hierarchical search for configuration files:

```
üìÅ External Configuration Search
/etc/myapp/config/
‚îú‚îÄ‚îÄ src/MyApp/Web/                    # Most specific
‚îú‚îÄ‚îÄ src/MyApp/                        # Less specific
‚îú‚îÄ‚îÄ src/                              # Less specific
‚îî‚îÄ‚îÄ /                                 # Least specific (root)
```

### Custom Environment Names

Override the environment name for configuration file resolution:

```bash
# Use custom environment name for configuration files
export AppsettingsEnvironmentName=Staging
# This loads appsettings.Staging.json instead of appsettings.Development.json
```

### Tag-Based Key Vault Filtering

Load only specific secrets from Key Vault using tag filtering:

```csharp
// Only load secrets tagged with "AppSettings"
builder.Host.ConfigureAppConfiguration2(
    loggerFactory,
    tags => tags.ContainsKey("AppSettings")
);

// Load secrets for specific environment
builder.Host.ConfigureAppConfiguration2(
    loggerFactory,
    tags => tags.TryGetValue("Environment", out var env) && 
            env == "Production"
);
```

### China Region Support

Automatic support for Azure China regions:

```json
{
  "AzureKeyVault": {
    "Uri": "https://your-keyvault.vault.azure.cn/",
    "TenantId": "your-tenant-cn"
  }
}
```

The system automatically detects China regions and sets the appropriate authority host.

## üåç Environment Support

### Development Environment

Provides enhanced developer experience:

- **Local override files** (`.local.json`)
- **Multiple authentication methods** (CLI, VS, VS Code)
- **Debug-friendly logging**
- **Source control safe** (local files excluded)

### Production Environment

Production-optimized features:

- **Managed Identity authentication**
- **External configuration folders**
- **Secure secret management**
- **Performance optimized**

### Custom Environments

Support for custom environment names:

```bash
# Custom environment
export DOTNET_ENVIRONMENT=Staging
export AppsettingsEnvironmentName=UAT

# This loads appsettings.UAT.json for the Staging environment
```

## üíª Best Practices

### üîí **Security**

1. **Never commit secrets** to source control
2. **Use managed identities** in production
3. **Add `*.local.json` to `.gitignore`**
4. **Use external folders** for sensitive configuration
5. **Implement proper access controls** on configuration folders

### üìÅ **File Organization**

```
üìÅ Recommended File Structure
‚îú‚îÄ‚îÄ appsettings.json                          # Base configuration
‚îú‚îÄ‚îÄ appsettings.Development.json              # Development settings
‚îú‚îÄ‚îÄ appsettings.Production.json               # Production settings
‚îú‚îÄ‚îÄ appsettings.local.json                    # Local overrides (gitignored)
‚îú‚îÄ‚îÄ appsettings.Development.local.json        # Dev local overrides (gitignored)
‚îî‚îÄ‚îÄ .gitignore                                # Include *.local.json
```

### ‚öôÔ∏è **Configuration Design**

1. **Use hierarchical keys** for organization:
   ```json
   {
     "Database": {
       "ConnectionString": "...",
       "Timeout": 30,
       "RetryPolicy": { "MaxAttempts": 3 }
     }
   }
   ```

2. **Separate concerns** by configuration section:
   ```json
   {
     "Logging": { ... },
     "ConnectionStrings": { ... },
     "ExternalServices": { ... },
     "FeatureFlags": { ... }
   }
   ```

3. **Use meaningful default values** in base configuration

### üöÄ **Development Workflow**

1. **Start with base configuration** (`appsettings.json`)
2. **Add environment-specific settings** (`appsettings.{Environment}.json`)
3. **Create local overrides** (`appsettings.local.json`) for development
4. **Use Key Vault** for production secrets
5. **Test configuration resolution** in different environments

## üêõ Troubleshooting

### Common Issues

#### **Configuration Not Loading**

**Problem**: Configuration values not being loaded as expected.

**Solutions**:
```csharp
// 1. Verify setup
builder.Host.ConfigureAppConfiguration2(loggerFactory);

// 2. Check file existence and naming
// - appsettings.json
// - appsettings.Development.json  
// - appsettings.local.json (Development only)

// 3. Verify environment variables
Console.WriteLine($"Environment: {Environment.GetEnvironmentVariable("DOTNET_ENVIRONMENT")}");
```

#### **Key Vault Access Issues**

**Problem**: Cannot access Azure Key Vault secrets.

**Solutions**:
```csharp
// 1. Verify authentication
// Development: Ensure Azure CLI login or VS authentication
// Production: Verify managed identity or client secret

// 2. Check Key Vault configuration
{
  "AzureKeyVault": {
    "Uri": "https://correct-keyvault-name.vault.azure.net/",
    "TenantId": "correct-tenant-id"
  }
}

// 3. Verify permissions
// Ensure the identity has "Key Vault Secrets User" role
```

#### **External Folder Not Found**

**Problem**: External configuration folder not being found.

**Solutions**:
```bash
# 1. Verify environment variable
echo $ExternalConfigurationFolder

# 2. Check folder exists and has correct permissions
ls -la /path/to/external/config

# 3. Verify hierarchical search paths
# The system searches from specific to general paths
```

### Debug Logging

Enable detailed logging to troubleshoot configuration issues:

```csharp
// In Program.cs
builder.Logging.AddFilter("Diginsight.Components.Configuration", LogLevel.Debug);

// Or in appsettings.json
{
  "Logging": {
    "LogLevel": {
      "Diginsight.Components.Configuration": "Debug"
    }
  }
}
```

### Configuration Inspection

Inspect loaded configuration values:

```csharp
// Dump all configuration
public void InspectConfiguration(IConfiguration configuration)
{
    foreach (var kvp in configuration.AsEnumerable())
    {
        Console.WriteLine($"{kvp.Key}: {kvp.Value}");
    }
}

// Check specific values
var connectionString = configuration.GetConnectionString("DefaultConnection");
var apiKey = configuration["ExternalServices:ApiKey"];
```

---

## Summary

Configuration Extensions provide a powerful enhancement to .NET's configuration system, offering:

- **Enhanced file hierarchy** with local development support
- **Seamless Azure Key Vault integration** with automatic authentication
- **External configuration folder** support for security
- **Backward compatibility** with existing .NET applications
- **Production-ready** security and performance features

By adopting Configuration Extensions, you get a more flexible, secure, and developer-friendly configuration system that scales from development to production environments.

**Next Steps**:
- Install `Diginsight.Components.Configuration`
- Replace your configuration setup with `ConfigureAppConfiguration2`
- Add `.local.json` files to `.gitignore`
- Configure Azure Key Vault for production secrets
- Explore advanced features like external folders and tag filtering
