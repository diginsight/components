# QueryCostMetricRecorder Overview

The `QueryCostMetricRecorder` provides recording automatically captures and records **CosmosDB query costs** as OpenTelemetry metrics.

`QueryCostMetricRecorder` is part of the Observable extensions for CosmosDB, from **Diginsight.Components.Azure**that provide observability into database performance by tracking Request Units (RU) consumption across your application's database operations.

## Overview

The `QueryCostMetricRecorder` works by listening to OpenTelemetry activities and automatically extracting query cost information from CosmosDB operations. When a database query completes, the recorder:

1. **Detects CosmosDB Operations**: Monitors activities for `query_cost` tags that indicate CosmosDB operations
2. **Extracts Metrics**: Captures the Request Units (RU) consumed by each query
3. **Enriches with Context**: Adds meaningful tags like method names, callers, database, and container information
4. **Records Histogram**: Stores the data as an OpenTelemetry histogram metric named `diginsight.query_cost`

### Key Features

- **Automatic Detection**: No manual instrumentation required - works with existing Diginsight telemetry
- **Query Normalization**: Optionally normalizes queries to reduce metric cardinality by replacing GUIDs, timestamps, and other high-cardinality values
- **Caller Tracking**: Traces back through the call stack to identify the business logic methods that triggered queries
- **Configurable Tags**: Flexible configuration for adding normalized queries and caller information to metrics
- **Error Resilience**: Handles exceptions gracefully without impacting application performance

### Metric Structure

The `diginsight.query_cost` metric is recorded as a histogram with the following characteristics:

- **Name**: `diginsight.query_cost`
- **Unit**: `RU` (Request Units)
- **Type**: Histogram
- **Description**: "CosmosDB query cost in Request Units"

## Additional Details

### How Query Cost Detection Works

The recorder implements the `IActivityListenerLogic` interface to monitor OpenTelemetry activities. When an activity stops, it:

1. Checks for the presence of a `query_cost` tag
2. Validates that the cost is a positive number
3. Extracts contextual information from the activity and its parent chain
4. Applies configured enrichment and filtering
5. Records the metric with appropriate tags

### Query Normalization

When `AddNormalizedQueryTag` is enabled, the recorder normalizes SQL queries to prevent metric cardinality explosion:

```csharp
// Original query
"SELECT * FROM c WHERE c.id = '123e4567-e89b-12d3-a456-426614174000' AND c.timestamp > '2023-01-01T10:30:00Z'"

// Normalized query
"SELECT * FROM c WHERE c.id = '{GUID}' AND c.timestamp > '{DATETIME}'"
```

Normalization patterns include:
- **GUIDs**: Replaced with `{GUID}`
- **Large Numbers**: Replaced with `{NUMBER}` (4+ digits)
- **Long Strings**: Replaced with `{STRING}`
- **DateTime Values**: Replaced with `{DATETIME}`
- **Length Limiting**: Queries over 500 characters are truncated

### Caller Chain Analysis

The recorder analyzes the activity parent chain to identify:
- **Entry Method**: The top-level method that initiated the operation
- **Business Callers**: Non-framework methods in the call chain (excludes "diginsight" internal calls)
- **Immediate Method**: The direct method that executed the query

### Tag Enrichment

Standard tags automatically added to metrics:
- `method`: The immediate method that executed the query
- `entrymethod`: The top-level entry point method
- `application`: The application name (from entry assembly)
- `container`: CosmosDB container name (if available)
- `database`: CosmosDB database name (if available)

Optional tags (configurable):
- `query`: Normalized query text
- `caller1`, `caller2`, etc.: Business logic methods in the call chain

## Configuration

### Basic Setup

Register the QueryCostMetricRecorder in your service collection:

```csharp
// In Program.cs or Startup.cs
services.AddCosmosDbQueryCostMetricRecorder();
```

### Advanced Configuration

Configure recorder options using the options pattern:

```csharp
services.Configure<QueryCostMetricRecorderOptions>(options =>
{
    // Add normalized query text as a tag (default: false)
    // WARNING: This can increase metric cardinality
    options.AddNormalizedQueryTag = true;
    
    // Add caller method names as tags (default: 0)
    // Values: 0-5 representing number of caller levels to include
    options.AddQueryCallers = 2;
});
```

### Configuration in appsettings.json

```json
{
  "QueryCostMetricRecorderOptions": {
    "AddNormalizedQueryTag": false,
    "AddQueryCallers": 1
  }
}
```

### OpenTelemetry Integration

Ensure your OpenTelemetry configuration includes the Diginsight meter:

```csharp
services.AddOpenTelemetry()
    .WithMetrics(builder =>
    {
        builder.AddMeter("Diginsight.Components.Azure");
        // Add other meters as needed
    });
```

### Custom Registration

For advanced scenarios, you can create custom registration logic:

```csharp
public class CustomQueryCostMetricRecorderRegistration : QueryCostMetricRecorderRegistration
{
    public CustomQueryCostMetricRecorderRegistration(QueryCostMetricRecorder recorder) 
        : base(recorder) { }

    public override bool ShouldListenTo(ActivitySource activitySource)
    {
        // Custom logic for which activity sources to monitor
        return activitySource.Name.Contains("MyApp.Data");
    }
}

// Register the custom implementation
services.AddCosmosDbQueryCostMetricRecorder<CustomQueryCostMetricRecorderRegistration>();
```

## Troubleshooting

### Common Issues

**1. No Metrics Being Recorded**

Check that:
- CosmosDB operations are properly instrumented with Diginsight telemetry
- Activities contain `query_cost` tags
- The metric recorder is registered in the service collection
- OpenTelemetry is configured to export the `Diginsight.Components.Azure` meter

**2. High Metric Cardinality**

If you experience high cardinality:
- Disable `AddNormalizedQueryTag` if enabled
- Reduce `AddQueryCallers` to 0 or 1
- Review query normalization patterns
- Implement custom `IMetricRecordingFilter` to exclude certain operations

**3. Missing Context Information**

Ensure that:
- Diginsight telemetry is properly configured
- Activities have appropriate parent-child relationships
- Container and database information is being tagged by the CosmosDB instrumentation

### Debugging

Enable detailed logging to troubleshoot issues:

```csharp
services.Configure<LoggerFilterOptions>(options =>
{
    options.AddFilter("Diginsight.Components.Azure.Metrics.QueryCostMetricRecorder", LogLevel.Debug);
});
```

### Performance Considerations

- Query normalization has minimal performance impact but can be disabled if needed
- Caller chain analysis processes only the activity hierarchy, not actual stack traces
- Metric recording is asynchronous and won't block database operations
- Consider metric retention policies in your observability platform

### Custom Filtering and Enrichment

Implement custom logic for filtering or enriching metrics:

```csharp
// Custom filter to exclude certain operations
public class CustomMetricFilter : IMetricRecordingFilter
{
    public bool ShouldRecord(Activity activity)
    {
        // Skip recording for health check queries
        return !activity.OperationName.Contains("HealthCheck");
    }
}

// Custom enricher to add additional tags
public class CustomMetricEnricher : IMetricRecordingEnricher
{
    public IEnumerable<KeyValuePair<string, object?>> ExtractTags(Activity activity)
    {
        yield return new KeyValuePair<string, object?>("custom_tag", "custom_value");
    }
}

// Register custom implementations
services.AddSingleton<IMetricRecordingFilter, CustomMetricFilter>();
services.AddSingleton<IMetricRecordingEnricher, CustomMetricEnricher>();
```

## Reference

### Classes and Interfaces

- **`QueryCostMetricRecorder`**: Main recorder class that implements `IActivityListenerLogic`
- **`QueryCostMetricRecorderOptions`**: Configuration options for the recorder
- **`QueryCostMetricRecorderRegistration`**: Default registration that determines which activities to monitor
- **`QueryMetrics`**: Static class containing the metric definitions
- **`IMetricRecordingFilter`**: Interface for custom filtering logic
- **`IMetricRecordingEnricher`**: Interface for custom tag enrichment

### Extension Methods

- **`AddCosmosDbQueryCostMetricRecorder()`**: Registers the recorder with default configuration
- **`AddCosmosDbQueryCostMetricRecorder<TRegistration>()`**: Registers with custom registration logic

### Metric Tags

| Tag Name | Description | Always Present |
|----------|-------------|----------------|
| `method` | Immediate method executing the query | ✓ |
| `entrymethod` | Top-level entry point method | ✓ |
| `application` | Application name | ✓ |
| `container` | CosmosDB container name | If available |
| `database` | CosmosDB database name | If available |
| `query` | Normalized query text | If configured |
| `caller1`, `caller2`, etc. | Business logic callers | If configured |

### Configuration Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `AddNormalizedQueryTag` | `bool` | `false` | Include normalized query text as tag |
| `AddQueryCallers` | `int` | `0` | Number of caller methods to include (0-5) |

For more information, see the [Diginsight Components documentation](https://diginsight.github.io/components/) and [OpenTelemetry .NET documentation](https://opentelemetry.io/docs/languages/net/).
